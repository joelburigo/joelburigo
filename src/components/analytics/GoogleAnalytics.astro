---
// Google Analytics 4 - Direct Implementation
// Hardcoded para simplificar (n√£o depende do GTM)
const GA4_ID = 'G-Z2XMZ448VV'
---

<!-- Google Analytics 4 - Professional Lazy Loading -->
<script is:inline define:vars={{ GA4_ID }}>
  (function() {
    let gaLoaded = false;
    
    // Initialize dataLayer buffer
    window.dataLayer = window.dataLayer || [];
    window.gtag = window.gtag || function(){dataLayer.push(arguments);};
    
    function initGA() {
      if (gaLoaded) return;
      gaLoaded = true;
      
      // Load gtag script
      const script = document.createElement('script');
      script.async = true;
      script.src = `https://www.googletagmanager.com/gtag/js?id=${GA4_ID}`;
      document.head.appendChild(script);
      
      gtag('js', new Date());
      gtag('config', GA4_ID, {
        page_path: window.location.pathname,
      });
    }
    
    // Strategy: Load on idle, interaction, or after page load
    const events = ['mousedown', 'touchstart', 'keydown'];
    events.forEach(event => {
      window.addEventListener(event, initGA, { once: true, passive: true });
    });
    
    // Use requestIdleCallback for optimal loading
    if ('requestIdleCallback' in window) {
      requestIdleCallback(() => {
        if (document.readyState === 'complete') {
          initGA();
        } else {
          window.addEventListener('load', initGA, { once: true });
        }
      }, { timeout: 1000 });
    } else {
      // Fallback: load after page load
      if (document.readyState === 'complete') {
        setTimeout(initGA, 0);
      } else {
        window.addEventListener('load', () => setTimeout(initGA, 0), { once: true });
      }
    }
  })();
</script>

<!-- Track GA4 on SPA navigation -->
<script>
  function trackGA4PageView() {
    if (typeof window !== 'undefined' && typeof (window as any).gtag === 'function') {
      (window as any).gtag('event', 'page_view', {
        page_location: window.location.href,
        page_path: window.location.pathname,
        page_title: document.title,
      });
    }
  }
  
  document.addEventListener('astro:after-swap', trackGA4PageView);
</script>
