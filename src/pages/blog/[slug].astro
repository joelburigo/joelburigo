---
import { getCollection, render } from 'astro:content'
import Layout from '../../layouts/Layout.astro'
import Header from '../../components/layout/Header.astro'
import Footer from '../../components/layout/Footer.astro'
import Container from '../../components/ui/Container.astro'
import AudioPlayer from '../../components/blog/AudioPlayer.astro'
import { Image } from 'astro:assets'
import Icons from '../../components/ui/Icons.astro'


export const prerender = true

export async function getStaticPaths() {
  const blogPosts = await getCollection('blog')
  
  if (!blogPosts || blogPosts.length === 0) {
    return []
  }
  
  return blogPosts.map((post) => ({
    params: { slug: post.id.replace(/\.md$/, '') },
    props: { post },
  }))
}

const { post } = Astro.props

if (!post) {
  return Astro.redirect('/blog')
}

const { Content } = await render(post)

const seo = {
  title: `${post.data.title} | Joel Burigo`,
  description: post.data.excerpt,
  keywords: `${post.data.category}, vendas, Joel Burigo`,
}

// Posts relacionados (busca outros posts da mesma categoria)
const allPosts = await getCollection('blog')
const relatedPosts = allPosts
  .filter((p) => p.data.category === post.data.category && p.id !== post.id)
  .slice(0, 3)

// Schema.org - Article Structured Data
const articleSchema = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": post.data.title,
  "description": post.data.excerpt,
  "author": {
    "@type": "Person",
    "name": post.data.author || "Joel Burigo",
    "url": "https://joelburigo.com.br/sobre"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Joel Burigo",
    "logo": {
      "@type": "ImageObject",
      "url": "https://joelburigo.com.br/logo.png"
    }
  },
  "datePublished": post.data.date.toISOString(),
  "dateModified": post.data.date.toISOString(),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": `https://joelburigo.com.br/blog/${post.id}`
  },
  "articleSection": post.data.category,
  "keywords": `${post.data.category}, vendas escaláveis, Joel Burigo`,
  "articleBody": post.data.excerpt
}
---

<Layout title={seo.title} description={seo.description} keywords={seo.keywords}>
  <!-- Schema.org JSON-LD -->
  <script is:inline type="application/ld+json" set:html={JSON.stringify(articleSchema)} />

  <Header />
  
  <!-- Reading Progress Bar -->
  <div class="reading-progress-bar"></div>
  
  <main class="flex-grow">
    <!-- Breadcrumb & Back -->
    <section class="bg-dark py-6">
      <Container>
        <a 
          href="/blog" 
          class="inline-flex items-center gap-2 font-display text-sm text-gray-200 transition-colors hover:text-lime"
        >
          <Icons name="arrow-left" class="h-4 w-4" />
          Voltar para o Blog
        </a>
      </Container>
    </section>

    <!-- Post Header -->
    <section class="bg-dark py-16">
      <Container>
        <article class="mx-auto max-w-3xl" data-pagefind-body>
          <div class="mb-6">
            <span 
              class="rounded-full bg-royal-blue/20 px-4 py-2 font-display text-sm font-semibold text-royal-blue"
              data-pagefind-meta="category"
            >
              {post.data.category}
            </span>
          </div>

          <h1 
            class="mb-6 font-display text-display-md text-white md:text-display-lg"
            data-pagefind-meta="title"
          >
            {post.data.title}
          </h1>

          {post.data.heroImage && (
            <div class="mb-8 overflow-hidden rounded-2xl">
              <Image 
                src={post.data.heroImage} 
                alt={post.data.title}
                loading="eager"
                class="w-full h-auto"
              />
            </div>
          )}

          <div class="mb-8 flex flex-wrap items-center gap-6 border-b border-white/10 pb-6" data-pagefind-ignore>
            <div class="flex items-center gap-2 font-sans text-body-sm text-gray-400">
              <Icons name="user" class="h-4 w-4" />
              <span data-pagefind-meta="author">{post.data.author}</span>
            </div>
            <div class="flex items-center gap-2 font-sans text-body-sm text-gray-400">
              <Icons name="calendar" class="h-4 w-4" />
              <span>{post.data.date.toLocaleDateString('pt-BR')}</span>
            </div>
            <div class="flex items-center gap-2 font-sans text-body-sm text-gray-400">
              <Icons name="clock" class="h-4 w-4" />
              <span>{post.data.readTime} de leitura</span>
              <div class="ml-2 h-1 w-16 overflow-hidden rounded-full bg-white/10">
                <div class="h-full bg-lime" style="width: 0%" data-reading-progress></div>
              </div>
            </div>
            <button id="share-button" class="ml-auto flex items-center gap-2 font-display text-sm text-lime transition-colors hover:text-lime/80">
              <Icons name="share-2" class="h-4 w-4" />
              <span>Compartilhar</span>
            </button>
          </div>

          <!-- Audio Player -->
          <AudioPlayer 
            audioUrl={`/audio/blog/${post.id.replace('.md', '')}.mp3`}
            title={post.data.title}
          />

          <!-- Table of Contents (for long articles) -->
          <nav class="toc-container sticky top-24 hidden xl:block" aria-label="Table of contents">
            <div class="rounded-xl border border-white/10 bg-white/5 p-4 backdrop-blur-sm">
              <h3 class="mb-3 font-display text-sm font-bold text-white">Neste Artigo</h3>
              <ul class="toc-list space-y-2 text-sm"></ul>
            </div>
          </nav>

          <!-- Post Content from Markdown -->
          <div class="prose-custom" data-pagefind-body id="article-content">
            <Content />
          </div>

          <!-- Post Footer / CTA -->
          <div class="mt-16 rounded-2xl border-2 border-lime/20 bg-lime/10 p-8 text-center">
            <h3 class="mb-4 font-display text-h2 text-white">
              Quer Implementar os 6Ps no Seu Negócio?
            </h3>
            <p class="mb-6 font-sans text-body-lg text-gray-200">
              No programa Vendas Sem Segredos, você aprende e implementa o Framework completo em 90 dias.
            </p>
            <a href="/vendas-sem-segredos">
              <button class="inline-flex items-center justify-center gap-2 rounded-lg bg-lime px-8 py-4 font-display text-lg font-bold text-dark shadow-lg shadow-lime/20 transition-all hover:scale-105 hover:bg-lime/90">
                Ver Programa Completo
              </button>
            </a>
          </div>
        </article>
      </Container>
    </section>

    <!-- Related Posts -->
    {relatedPosts.length > 0 && (
      <section class="bg-dark py-24">
        <Container>
          <h2 class="mb-12 text-center font-display text-display-sm text-white">
            Artigos Relacionados
          </h2>

          <div class="grid grid-cols-1 gap-8 md:grid-cols-3">
            {relatedPosts.map((relatedPost) => (
              <a
                href={`/blog/${relatedPost.id}`}
                class="group flex flex-col overflow-hidden rounded-2xl border-2 border-white/10 bg-white/5 p-6 backdrop-blur-sm transition-all hover:border-lime/50"
              >
                <span class="mb-3 inline-block w-fit rounded-full bg-royal-blue/20 px-3 py-1 font-display text-xs font-semibold text-royal-blue">
                  {relatedPost.data.category}
                </span>
                <h3 class="font-display text-h4 text-white transition-colors group-hover:text-lime">
                  {relatedPost.data.title}
                </h3>
              </a>
            ))}
          </div>
        </Container>
      </section>
    )}
  </main>

  <!-- Back to Top Button -->
  <button 
    id="back-to-top"
    class="back-to-top-btn"
    aria-label="Voltar ao topo"
  >
    <Icons name="arrow-up" class="h-5 w-5" />
  </button>

  <Footer />
</Layout>

<style>
  /* Reading Progress Bar */
  .reading-progress-bar {
    position: fixed;
    top: 0;
    left: 0;
    height: 3px;
    background: linear-gradient(to right, #a3ff3f, #8fd639);
    width: 0%;
    z-index: 9999;
    transition: width 0.1s ease;
  }

  /* Table of Contents */
  .toc-container {
    position: absolute;
    right: -300px;
    top: 0;
    width: 250px;
  }

  @media (min-width: 1280px) {
    .toc-container {
      display: block !important;
    }
  }

  .toc-list a {
    display: block;
    color: #9ca3af;
    text-decoration: none;
    transition: color 0.2s;
    padding: 0.25rem 0;
    border-left: 2px solid transparent;
    padding-left: 0.75rem;
  }

  .toc-list a:hover {
    color: #a3ff3f;
  }

  .toc-list a.active {
    color: #a3ff3f;
    border-left-color: #a3ff3f;
  }

  /* Back to Top Button */
  .back-to-top-btn {
    position: fixed;
    bottom: 2rem;
    right: 2rem;
    width: 3rem;
    height: 3rem;
    border-radius: 50%;
    background: #a3ff3f;
    color: #0f172a;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(163, 255, 63, 0.3);
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s ease;
    z-index: 50;
    cursor: pointer;
    border: none;
  }

  .back-to-top-btn.visible {
    opacity: 1;
    visibility: visible;
  }

  .back-to-top-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 6px 16px rgba(163, 255, 63, 0.4);
  }

  .prose-custom {
    color: #d1d5db;
    font-size: 1.125rem;
    line-height: 1.9;
  }

  .prose-custom :global(h2) {
    margin-top: 3.5rem;
    margin-bottom: 1.5rem;
    font-family: 'Montserrat', sans-serif;
    font-size: 2rem;
    font-weight: 700;
    color: white;
    scroll-margin-top: 6rem;
  }

  .prose-custom :global(h3) {
    margin-top: 2.5rem;
    margin-bottom: 1.25rem;
    font-family: 'Montserrat', sans-serif;
    font-size: 1.5rem;
    font-weight: 600;
    color: white;
    scroll-margin-top: 6rem;
  }

  .prose-custom :global(p) {
    margin-bottom: 1.5rem;
  }

  .prose-custom :global(strong) {
    color: white;
    font-weight: 600;
  }

  .prose-custom :global(ul) {
    margin: 2rem 0;
    list-style-type: disc;
    padding-left: 1.75rem;
  }

  .prose-custom :global(li) {
    margin-bottom: 1rem;
  }

  .prose-custom :global(blockquote) {
    margin: 3rem 0;
    padding: 1.5rem;
    padding-left: 1.5rem;
    border-left: 4px solid #a3ff3f;
    background: rgba(163, 255, 63, 0.05);
    border-radius: 0 0.5rem 0.5rem 0;
    font-size: 1.125rem;
    font-style: italic;
    color: #e5e7eb;
  }

  /* Callout Boxes */
  .prose-custom :global(.callout) {
    margin: 2rem 0;
    padding: 1.5rem;
    border-radius: 0.75rem;
    border-left: 4px solid;
  }

  .prose-custom :global(.callout-info) {
    background: rgba(59, 130, 246, 0.1);
    border-color: #3b82f6;
  }

  .prose-custom :global(.callout-warning) {
    background: rgba(251, 191, 36, 0.1);
    border-color: #fbbf24;
  }

  .prose-custom :global(.callout-success) {
    background: rgba(163, 255, 63, 0.1);
    border-color: #a3ff3f;
  }

  .prose-custom :global(a) {
    color: #a3ff3f;
    text-decoration: underline;
    text-decoration-thickness: 1px;
    text-underline-offset: 2px;
    transition: color 0.2s;
  }

  .prose-custom :global(a:hover) {
    color: #8fd639;
  }

  .prose-custom :global(code) {
    background-color: rgba(163, 255, 63, 0.1);
    padding: 0.2rem 0.4rem;
    border-radius: 0.25rem;
    font-size: 0.9em;
    color: #a3ff3f;
  }
</style>

<script>
  // Reading Progress Bar
  function updateReadingProgress() {
    const article = document.getElementById('article-content');
    const progressBar = document.querySelector('.reading-progress-bar') as HTMLElement;
    const progressIndicator = document.querySelector('[data-reading-progress]') as HTMLElement;
    
    if (!article || !progressBar) return;
    
    const articleTop = article.offsetTop;
    const articleHeight = article.offsetHeight;
    const windowHeight = window.innerHeight;
    const scrollY = window.scrollY;
    
    const articleStart = articleTop - windowHeight / 2;
    const articleEnd = articleTop + articleHeight - windowHeight / 2;
    const progress = ((scrollY - articleStart) / (articleEnd - articleStart)) * 100;
    
    const clampedProgress = Math.min(Math.max(progress, 0), 100);
    progressBar.style.width = `${clampedProgress}%`;
    if (progressIndicator) {
      progressIndicator.style.width = `${clampedProgress}%`;
    }
  }

  // Back to Top Button
  function updateBackToTop() {
    const btn = document.getElementById('back-to-top');
    if (!btn) return;
    
    if (window.scrollY > 500) {
      btn.classList.add('visible');
    } else {
      btn.classList.remove('visible');
    }
  }

  document.getElementById('back-to-top')?.addEventListener('click', () => {
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // Table of Contents
  function buildTOC() {
    const article = document.getElementById('article-content');
    const tocList = document.querySelector('.toc-list');
    if (!article || !tocList) return;
    
    const headings = article.querySelectorAll('h2, h3');
    if (headings.length === 0) return;
    
    headings.forEach((heading, index) => {
      const id = heading.id || `heading-${index}`;
      if (!heading.id) heading.id = id;
      
      const li = document.createElement('li');
      const a = document.createElement('a');
      a.href = `#${id}`;
      a.textContent = heading.textContent || '';
      a.className = heading.tagName === 'H3' ? 'pl-4' : '';
      
      a.addEventListener('click', (e) => {
        e.preventDefault();
        heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
      });
      
      li.appendChild(a);
      tocList.appendChild(li);
    });
  }

  // Highlight active TOC item
  function updateActiveTOC() {
    const headings = document.querySelectorAll('#article-content h2, #article-content h3');
    const tocLinks = document.querySelectorAll('.toc-list a');
    
    let activeIndex = -1;
    headings.forEach((heading, index) => {
      const rect = heading.getBoundingClientRect();
      if (rect.top < 200) {
        activeIndex = index;
      }
    });
    
    tocLinks.forEach((link, index) => {
      if (index === activeIndex) {
        link.classList.add('active');
      } else {
        link.classList.remove('active');
      }
    });
  }

  // Share button functionality
  const shareButton = document.getElementById('share-button');
  shareButton?.addEventListener('click', async () => {
    const url = window.location.href;
    const title = document.title;
    
    if (navigator.share) {
      try {
        await navigator.share({ title, url });
      } catch (err) {
        if ((err as Error).name !== 'AbortError') {
          console.log('Error sharing:', err);
        }
      }
    } else {
      // Fallback: copy to clipboard
      try {
        await navigator.clipboard.writeText(url);
        const originalText = shareButton.querySelector('span');
        if (originalText) {
          const backup = originalText.textContent;
          originalText.textContent = 'Link copiado!';
          setTimeout(() => {
            originalText.textContent = backup;
          }, 2000);
        }
      } catch (err) {
        console.log('Error copying:', err);
      }
    }
  });

  // Initialize everything
  document.addEventListener('DOMContentLoaded', () => {
    buildTOC();
    updateReadingProgress();
    updateBackToTop();
    updateActiveTOC();
  });

  // Update on scroll
  let ticking = false;
  window.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateReadingProgress();
        updateBackToTop();
        updateActiveTOC();
        ticking = false;
      });
      ticking = true;
    }
  });
</script>
