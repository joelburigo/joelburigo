---
interface Props {
  audioUrl: string;
  title: string;
}

const { audioUrl, title } = Astro.props;
---

<div class="audio-player-wrapper my-8 rounded-2xl border-2 border-lime/20 bg-gradient-to-br from-lime/5 to-lime/10 p-6 backdrop-blur-sm">
  <div class="flex items-start gap-4">
    <!-- Icon -->
    <div class="flex-shrink-0">
      <div class="flex h-12 w-12 items-center justify-center rounded-full bg-lime/20">
        <svg class="h-6 w-6 text-lime" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 14.5v-9l6 4.5-6 4.5z"/>
        </svg>
      </div>
    </div>

    <!-- Content -->
    <div class="flex-grow">
      <div class="mb-3">
        <h3 class="font-display text-lg font-bold text-white mb-1">
          ðŸŽ§ OuÃ§a este artigo
        </h3>
        <p class="text-sm text-gray-300">
          NarraÃ§Ã£o por IA com voz natural em portuguÃªs
        </p>
      </div>

      <!-- Audio Player -->
      <div class="audio-controls">
        <audio 
          id="article-audio"
          preload="metadata"
          class="w-full"
          controlsList="nodownload"
        >
          <source src={audioUrl} type="audio/mpeg" />
          Seu navegador nÃ£o suporta Ã¡udio HTML5.
        </audio>

        <!-- Custom Controls -->
        <div class="mt-3 flex items-center gap-3">
          <button
            id="play-pause-btn"
            class="flex h-10 w-10 items-center justify-center rounded-full bg-lime transition-all hover:scale-105 hover:bg-lime/90"
            aria-label="Play/Pause"
            style="color: #020617;"
          >
            <svg id="play-icon" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
              <path d="M8 5v14l11-7z"/>
            </svg>
            <svg id="pause-icon" class="h-5 w-5 hidden" fill="currentColor" viewBox="0 0 24 24">
              <path d="M6 4h4v16H6V4zm8 0h4v16h-4V4z"/>
            </svg>
          </button>

          <!-- Progress Bar -->
          <div class="flex-grow">
            <div class="mb-1 flex justify-between text-xs text-gray-400">
              <span id="current-time">0:00</span>
              <span id="duration">0:00</span>
            </div>
            <input
              type="range"
              id="progress-bar"
              min="0"
              max="100"
              value="0"
              class="h-2 w-full cursor-pointer appearance-none rounded-full bg-gray-700"
              style="background: linear-gradient(to right, #84CC16 0%, #84CC16 0%, #374151 0%, #374151 100%);"
            />
          </div>

          <!-- Speed Control -->
          <select
            id="playback-speed"
            class="rounded-lg border border-gray-600 bg-gray-800 px-2 py-1 text-sm text-gray-200 transition-colors hover:border-lime focus:border-lime focus:outline-none"
          >
            <option value="0.75">0.75x</option>
            <option value="1" selected>1x</option>
            <option value="1.25">1.25x</option>
            <option value="1.5">1.5x</option>
            <option value="2">2x</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  #progress-bar::-webkit-slider-thumb {
    -webkit-appearance: none;
    appearance: none;
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #84CC16;
    cursor: pointer;
    border: 2px solid #020617;
  }

  #progress-bar::-moz-range-thumb {
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background: #84CC16;
    cursor: pointer;
    border: 2px solid #020617;
  }
</style>

<script>
  const audio = document.getElementById('article-audio') as HTMLAudioElement;
  const playPauseBtn = document.getElementById('play-pause-btn');
  const playIcon = document.getElementById('play-icon');
  const pauseIcon = document.getElementById('pause-icon');
  const progressBar = document.getElementById('progress-bar') as HTMLInputElement;
  const currentTimeEl = document.getElementById('current-time');
  const durationEl = document.getElementById('duration');
  const speedSelect = document.getElementById('playback-speed') as HTMLSelectElement;

  if (audio && playPauseBtn && progressBar) {
    // Play/Pause
    playPauseBtn.addEventListener('click', () => {
      if (audio.paused) {
        audio.play();
        playIcon?.classList.add('hidden');
        pauseIcon?.classList.remove('hidden');
      } else {
        audio.pause();
        playIcon?.classList.remove('hidden');
        pauseIcon?.classList.add('hidden');
      }
    });

    // Update progress bar
    audio.addEventListener('timeupdate', () => {
      if (audio.duration) {
        const progress = (audio.currentTime / audio.duration) * 100;
        progressBar.value = progress.toString();
        progressBar.style.background = `linear-gradient(to right, #84CC16 0%, #84CC16 ${progress}%, #374151 ${progress}%, #374151 100%)`;
        
        if (currentTimeEl) {
          currentTimeEl.textContent = formatTime(audio.currentTime);
        }
      }
    });

    // Duration loaded
    audio.addEventListener('loadedmetadata', () => {
      if (durationEl) {
        durationEl.textContent = formatTime(audio.duration);
      }
    });

    // Seek
    progressBar.addEventListener('input', () => {
      if (audio.duration) {
        const time = (parseFloat(progressBar.value) / 100) * audio.duration;
        audio.currentTime = time;
      }
    });

    // Speed control
    speedSelect?.addEventListener('change', () => {
      audio.playbackRate = parseFloat(speedSelect.value);
    });

    // Reset on end
    audio.addEventListener('ended', () => {
      playIcon?.classList.remove('hidden');
      pauseIcon?.classList.add('hidden');
    });
  }

  function formatTime(seconds: number): string {
    const mins = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${mins}:${secs.toString().padStart(2, '0')}`;
  }
</script>
