---
// Cookie Consent Banner - Simplified for GTM
// Only pushes consent state to dataLayer
// GTM handles Consent Mode v2 configuration
---

<div
  id="cookie-consent-banner"
  class="fixed bottom-0 left-0 right-0 z-50 transform translate-y-full bg-dark/98 p-6 shadow-2xl backdrop-blur-lg transition-transform duration-300 will-change-transform"
  style="opacity: 0; pointer-events: none;"
  data-consent-banner
>
  <div class="container mx-auto max-w-7xl">
    <div class="flex flex-col items-center justify-between gap-4 md:flex-row">
      <div class="flex-1">
        <h3 class="mb-2 font-display text-h4 text-white">ğŸª Cookies e Privacidade</h3>
        <p class="font-sans text-body-sm text-gray-200">
          Usamos cookies para melhorar sua experiÃªncia, personalizar conteÃºdo e analisar o trÃ¡fego do
          site. Ao clicar em "Aceitar", vocÃª concorda com o uso de cookies.
          <a href="/privacidade" class="text-lime hover:underline">PolÃ­tica de Privacidade</a>
        </p>
      </div>
      <div class="flex gap-3">
        <button
          id="cookie-reject"
          class="rounded-lg border-2 border-white/20 px-6 py-2 font-display text-sm font-semibold text-white transition-colors hover:bg-white/10"
        >
          Rejeitar
        </button>
        <button
          id="cookie-accept"
          class="rounded-lg bg-lime px-6 py-2 font-display text-sm font-bold text-dark transition-all hover:bg-lime/90"
        >
          Aceitar Todos
        </button>
      </div>
    </div>
  </div>
</div>

<script>
  function initCookieConsent() {
    const banner = document.querySelector('[data-consent-banner]') as HTMLElement
    const acceptBtn = document.getElementById('cookie-accept')
    const rejectBtn = document.getElementById('cookie-reject')

    if (!banner || !acceptBtn || !rejectBtn) return

    // Check if user already made a choice
    const consent = localStorage.getItem('cookie_consent')
    if (!consent) {
      // Delay banner display to avoid being LCP (wait for hero to load)
      requestIdleCallback(() => {
        // Use requestAnimationFrame to avoid forced reflow
        requestAnimationFrame(() => {
          banner.style.opacity = '1'
          banner.style.pointerEvents = 'auto'
          banner.classList.remove('translate-y-full')
          banner.classList.add('translate-y-0')
        })
      }, { timeout: 1500 })
    }

    // Helper to push consent state to dataLayer
    const updateConsent = (accepted: boolean) => {
      localStorage.setItem('cookie_consent', accepted ? 'accepted' : 'rejected')
      
      // Animate out without forced reflow
      requestAnimationFrame(() => {
        banner.classList.remove('translate-y-0')
        banner.classList.add('translate-y-full')
        banner.style.opacity = '0'
        banner.style.pointerEvents = 'none'
      })
      
      // Push consent state to dataLayer for GTM
      window.dataLayer = window.dataLayer || []
      window.dataLayer.push({
        event: 'cookie_consent_update',
        consent_state: accepted ? 'granted' : 'denied',
        analytics_storage: accepted ? 'granted' : 'denied',
        ad_storage: accepted ? 'granted' : 'denied',
        ad_user_data: accepted ? 'granted' : 'denied',
        ad_personalization: accepted ? 'granted' : 'denied',
        personalization_storage: accepted ? 'granted' : 'denied',
      })
    }

    // Accept button
    acceptBtn.addEventListener('click', () => updateConsent(true))

    // Reject button
    rejectBtn.addEventListener('click', () => updateConsent(false))
  }

  // Initialize on page load
  initCookieConsent()

  // Re-initialize after View Transitions
  document.addEventListener('astro:page-load', initCookieConsent)
</script>
